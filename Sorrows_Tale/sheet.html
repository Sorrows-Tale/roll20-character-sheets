<!-- ------------------------ -->
<!-- Start of: Header Section -->
<!-- ------------------------ -->
<div class="header-container">
    <div class="div__left">
        <img class="img-logo-head" src="https://raw.githubusercontent.com/Sorrows-Tale/roll20-character-sheets/master_v0.1/Sorrows_Tale/st_logo1.png" />
    </div>
    <div class="div__left">
        <div class="div__char-name">
            <p class="p__font--helvetica">Character Name:</p> 
            <input type="text" class="input-text__border--trans" name="attr_character_name" maxlength="28" size="32" autocomplete="off"/>
        </div>
        <br />&nbsp;&nbsp;
        <button type="action" name="act_page1" >Main</button>
        <button type="action" name="act_page2" >Page 2</button>
        <button type="action" name="act_page3" >Page 3</button>
    </div>
    <div class="div__counters">
        <div class="div__left">
            <p class="p__font--helvetica">&nbsp;&nbsp;&nbsp;Health:</p>
            <div class="div-bi-value-pill-box">
                <input type="number" name="attr_health_max" min="0" max="999" class="input-number__counter" />
                <input type="number" name="attr_health" min="-99" max="999" class="input-number__counter" style="border-left: solid 2px;"/>
                <p class="p-fullremain-label">&nbsp;&nbsp;&nbsp;Full&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Current</p>
            </div>
        </div>    
        <div class="div__left">
            <p class="p__font--helvetica">&nbsp;&nbsp;&nbsp;Will:</p>
            <div class="div-bi-value-pill-box">
                <input type="number" name="attr_will_max" min="0" max="999" class="input-number__counter" />
                <input type="number" name="attr_will" min="-99" max="999" class="input-number__counter" style="border-left: solid 2px;"/>
                <p class="p-fullremain-label">&nbsp;&nbsp;&nbsp;Full&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Current</p>
            </div>
        </div>
        <div class="div__left">
            <p class="p__font--helvetica">&nbsp;&nbsp;&nbsp;Luck:</p>
            <div class="div-bi-value-pill-box">
                <input type="number" name="attr_luck_max" min="0" max="10" value=10 class="input-number__counter" />
                <input type="number" name="attr_luck" min="-99" max="999" class="input-number__counter" style="border-left: solid 2px;"/>
                <p class="p-fullremain-label">&nbsp;&nbsp;&nbsp;Max&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Current</p>
            </div>
        </div>
        <div class="div-major-wound">
            <input type="checkbox" value="1" class="input-cb-maj-wound" name="attr_major_wound" style="float:left;" />
            <input type="hidden" name="attr_major_wound" value="@{major_wound}" class="input-ctr-maj-wound-text-display"/>
            <p class="p-major-wound">Major Wound</p>
            <input type="text" class="input-text-maj-wound-desc" name="attr_maj_wound_desc" />
        </div>        
    </div>
</div>
<input type="hidden" class="tabstoggle" name="attr_sheetTab"  value="page1"  />
<!-- End of: Header Section -->

<!-- ---------------- -->
<!-- Start of: Page 1 -->
<!-- ---------------- -->
<div class="page1 div-p1" >

    <div class='3colrow'>
        <div class='col div-p1col1'>
            <!-- Page 1 column 1 contents -->
                                  
            <div class="div__attributes">
                
                <!-- strength -->
                <div class="div-attrib-box">
                    <p class="p-attr-name">Strength</p>
                    <div class="div-attrib-box__full">
                        <input type="number" name="attr_strength" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                    <div class="div-attrib-box__curr">
                        <input type="number" name="attr_strength_curr" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                </div>
                <div style="float:left; margin-left:6px;">
                    &nbsp;⇒<button type="roll" value="@{roll-ability__str}" name="roll_strength" ></button><br>
                    <div class="div-attrib-box__mod">
                        <input type="hidden" name="attr_strength_mod" value="0" />
                        <input type="text" name="attr_strength_mod_disp" min="-12" max="12" class="input-number__mod-box" disabled="true" value="@{strength_mod}"/>
                    </div>
                </div>
                                
                <!-- constitution -->
                <div class="div-attrib-box">
                    <p class="p-attr-name">Constitution</p>
                    <div class="div-attrib-box__full">
                        <input type="number" name="attr_constitution" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                    <div class="div-attrib-box__curr">
                        <input type="number" name="attr_constitution_curr" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                </div>
                <div style="float:left; margin-left:6px;">
                    &nbsp;⇒<button type="roll" value="@{roll-ability__con}" name="roll_constitution"></button><br>
                    <div class="div-attrib-box__mod">
                        <input type="hidden" name="attr_constitution_mod" value="0" />
                        <input type="text" name="attr_constitution_mod_disp" min="-12" max="12" class="input-number__mod-box" disabled="true" value="@{constitution_mod}"/>
                    </div>
                </div>

                <!-- agility -->
                <div class="div-attrib-box">
                    <p class="p-attr-name">Agility</p>
                    <div class="div-attrib-box__full">
                        <input type="number" name="attr_agility" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                    <div class="div-attrib-box__curr">
                        <input type="number" name="attr_agility_curr" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                </div>
                <div style="float:left; margin-left:6px;">
                    &nbsp;⇒<button type="roll" value="@{roll-ability__agi}" name="roll_agility" ></button><br>
                    <div class="div-attrib-box__mod">
                        <input type="hidden" name="attr_agility_mod" value="0" />
                        <input type="text" name="attr_agility_mod_disp" min="-12" max="12" class="input-number__mod-box" disabled="true" value="@{agility_mod}"/>
                    </div>
                </div>

                <!-- awareness -->
                <div class="div-attrib-box">
                    <p class="p-attr-name">Awareness</p>
                    <div class="div-attrib-box__full">
                        <input type="number" name="attr_aware" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                    <div class="div-attrib-box__curr">
                        <input type="number" name="attr_aware_curr" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                </div>
                <div style="float:left; margin-left:6px;">
                    &nbsp;⇒<button type="roll" value="@{roll-ability__awa}" name="roll_aware"></button><br>
                    <div class="div-attrib-box__mod">
                        <input type="hidden" name="attr_aware_mod" value="0" />
                        <input type="text" name="attr_aware_mod_disp" min="-12" max="12" class="input-number__mod-box" disabled="true" value="@{aware_mod}"/>
                    </div>
                </div>

                <!-- willpower -->
                <div class="div-attrib-box">
                    <p class="p-attr-name">Willpower</p>
                    <div class="div-attrib-box__full">
                        <input type="number" name="attr_willpower" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                    <div class="div-attrib-box__curr">
                        <input type="number" name="attr_willpower_curr" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                </div>
                <div style="float:left; margin-left:6px;">
                    &nbsp;⇒<button type="roll" value="@{roll-ability__wil}" name="roll_willpower" ></button><br>
                    <div class="div-attrib-box__mod">
                        <input type="hidden" name="attr_willpower_mod" value="0" />
                        <input type="text" name="attr_willpower_mod_disp" min="-12" max="12" class="input-number__mod-box" disabled="true" value="@{willpower_mod}"/>
                    </div>
                </div>

                <!-- Intelligence -->
                <div class="div-attrib-box">
                    <p class="p-attr-name">Intelligence</p>
                    <div class="div-attrib-box__full">
                        <input type="number" name="attr_intelligence" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                    <div class="div-attrib-box__curr">
                        <input type="number" name="attr_intelligence_curr" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                </div>
                <div style="float:left; margin-left:6px;">
                    &nbsp;⇒<button type="roll" value="@{roll-ability__int}" name="roll_intelligence" ></button><br>
                    <div class="div-attrib-box__mod">
                        <input type="hidden" name="attr_intelligence_mod" value="0" />
                        <input type="text" name="attr_intelligence_mod_disp" min="-12" max="12" class="input-number__mod-box" disabled="true" value="@{intelligence_mod}"/>
                    </div>
                </div>

                <!-- Social Ability -->
                <div class="div-attrib-box">
                    <p class="p-attr-name">Social Ability</p>
                    <div class="div-attrib-box__full">
                        <input type="number" name="attr_social" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                    <div class="div-attrib-box__curr">
                        <input type="number" name="attr_social_curr" min="0" max="40" class="input-number__attrib-box" />
                    </div>
                    <div>
                        <p class="p-attr-fullcurr-label">[ Full ]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ Curr ]</p>
                    </div>
                </div>
                <div style="float:left; margin-left:6px;">
                    &nbsp;⇒<button type="roll" value="@{roll-ability__soc}" name="roll_Social" ></button><br>
                    <div class="div-attrib-box__mod">
                        <input type="hidden" name="attr_social_mod" value="0" />
                        <input type="text" name="attr_social_mod_disp" class="input-number__mod-box" disabled="true" value="@{social_mod}"/>
                        <p class="p-attr-fullcurr-label" style="margin-top: 3px; margin-left: -4px;">[ Mod ]</p>
                    </div>
                    
                </div>
            </div>     
        </div>
        <div class='col div-p1col2'>
            <!-- Page 1 column 2 contents -->
            <div class="div__defense">
                <img class="img-def-ribbon" src="https://raw.githubusercontent.com/Sorrows-Tale/roll20-character-sheets/master_v0.1/Sorrows_Tale/def_ribbon_v2.png" /><br />
                <div class="div-defense-row1">
                    <p class="p-box-text div__left div__left" style="padding-top: 3px;">Defense&nbsp;<br />&nbsp;Rating</p>
                    <p class="p__font--helvetica p__font-size__16 div__left">&nbsp;=&nbsp;&nbsp;10 +&nbsp;</p>
                    <p class="p-box-text div__left" style="padding-top: 3px;">
                        Agility<br />&nbsp;Mod
                    </p>
                    <p class="p__font--helvetica p__font-size__16 div__left" >&nbsp;+&nbsp;</p>
                    <p class="p-box-text div__left" style="padding-top: 3px;">
                        Talent&nbsp;<br />&nbsp;&nbsp;Mod
                    </p>
                    <p class="p-box-text div__left" style="margin-top: -4px;">
                        <input type="number" name="attr_defense_talent_mod" min="0" max="12" class="input-defense-talent-mod" value="0" /><br />
                    </p>    
                </div>
                <div class="div-defense-row2">
                    <div class="div-def-rate-disp">
                        <input type="hidden" name="attr_defense_rating" value="0"/>
                        <input type="text" name="attr_defense_rating_disp" min="-99" max="99" class="input-def-box" disabled="true" value="@{defense_rating}"/><br />
                        <p class="p-box-text div__left div__left" style="padding-top: 13px;">Defense<br />&nbsp;Rating</p>
                    </div>
                    <p class="p__font--helvetica p__font-size__16 div__left" style="padding-top: 13px;">&nbsp;&nbsp;+&nbsp;&nbsp;</p>
                    <div class="div-def-shield-rating">
                        <input type="number" name="attr_shield_rating" min="0" max="9" class="input-shield-rating" value="0" /><br />
                        <p class="p-box-text div__left div__left" style="padding: 9px 0px 0px 7px;">Shield<br />Rating</p>
                    </div>
                    <p class="p__font--helvetica p__font-size__16 div__left" style="padding-top: 13px;">&nbsp;&nbsp;=&nbsp;&nbsp;</p>
                    <div class="div-def-rate-disp">
                        <input type="hidden" name="attr_with_shield_rating" value="0"/>
                        <input type="text" name="attr_with_shield_rating_disp" min="-99" max="99" class="input-def-box" disabled="true" value="@{with_shield_rating}"/><br />
                        <p class="p-box-text div__left div__left" style="padding-top: 13px; width:54px; margin-left: -8px;">Def. Rating<br />with Shield</p>
                    </div>
                </div>     
            </div>
            <div class="div__armor_ratings">
                <img class="img-armor-ribbon" src="https://raw.githubusercontent.com/Sorrows-Tale/roll20-character-sheets/master_v0.1/Sorrows_Tale/armor_ribbon.png"/>    
                <div class="div-armor-row1">
                    <div class="div-armor-ratetype">
                        <input type="number" name="attr_armor_rate_blunt" min="0" max="10" class="input-armor-rating" value="0" /><br />
                        <p class="p-armor-rate-text div__left" style="padding: 9px 0px 0px 11px;">Blunt</p>        
                    </div>
                    <div class="div-armor-ratetype">
                        <input type="number" name="attr_armor_rate_slash" min="0" max="10" class="input-armor-rating" value="0" /><br />
                        <p class="p-armor-rate-text div__left" style="padding: 9px 0px 0px 11px;">Slash</p>        
                    </div>
                    <div class="div-armor-ratetype">
                        <input type="number" name="attr_armor_rate_pierce" min="0" max="10" class="input-armor-rating" value="0" /><br />
                        <p class="p-armor-rate-text div__left" style="padding: 9px 0px 0px 7px;">Pierce</p>        
                    </div>
                    <div class="div-armor-ratetype">
                        <input type="number" name="attr_armor_rate_conduct" min="0" max="10" class="input-armor-rating" value="0" /><br />
                        <p class="p-armor-rate-text div__left" style="padding: 9px 0px 0px 2px;">Conduct</p>        
                    </div>
                    <div class="div-box-dam-resist" name="amount">
                        <input type="number" name="attr_armor_damage" min="0" max="10" class="input-dam-resist" value="0" /><br />
                        <p class="p-armor-dam-text div__left" style="padding: 1px 0px 0px 6px;">&nbsp;Armor<br>Damage</p>        
                    </div>
                </div>
                <div class="div-armor-row2">
                    <div class="div-armor-ratetype">
                        <input type="number" name="attr_armor_rate_temp" min="0" max="10" class="input-armor-rating" value="0" /><br />
                        <p class="p-armor-rate-text div__left div__left" style="padding: 9px 0px 0px 9px;">Temp.</p>        
                    </div>
                    <div class="div-armor-ratetype">
                        <input type="number" name="attr_armor_rate_corrode" min="0" max="10" class="input-armor-rating" value="0" /><br />
                        <p class="p-armor-rate-text div__left div__left" style="padding: 9px 0px 0px 4px;">Corrode</p>        
                    </div>
                    <div class="div-armor-ratetype">
                        <input type="number" name="attr_armor_rate_sonic" min="0" max="10" class="input-armor-rating" value="0" /><br />
                        <p class="p-armor-rate-text div__left div__left" style="padding: 9px 0px 0px 10px;">Sonic</p>        
                    </div>
                    <div class="div-armor-ratetype">
                        <input type="number" name="attr_armor_rate_deific" min="0" max="10" class="input-armor-rating" value="0" /><br />
                        <p class="p-armor-rate-text div__left div__left" style="padding: 9px 0px 0px 11px;">Deific</p>        
                    </div>
                    <div class="div-box-dam-resist" name="perc">
                        <input type="number" name="attr_armor_damage_resist" min="0" max="100" class="input-dam-resist" value="0" /><br />
                        <p class="p-armor-dam-text div__left" style="padding: 1px 0px 0px 0px;">&nbsp;&nbsp;Damage<br>Resistance</p>        
                    </div>
                </div>
            </div>
            <div class="div-actions">
                <div class="div-top-band">
                    <h3 style="text-align: center;">Action Section</h3>
                </div>
                <div class="div-action-repeating">
                    <fieldset class="repeating_actions">
                        
                       
                            <select name="attr_action_type" class="input-action-type">
                                <option selected>Attack</option>
                                <option>Spell</option>
                                <option>Action</option>
                            </select>       
                            <input type="text" name="attr_action_desc" value="" class="input-action-desc" placeholder="Description">
                            <button type="roll" name="roll_action" value="/em xyz example"></button>
                          
                    </fieldset>
                </div>
            </div>
        <div class='col'>
            <!-- Third column -->
        </div>
    </div>   
</div>
<!-- End of: Page 1 -->


<div class="page2">
    <h2>Journal/Notes</h2>
    <span>Journal/Notes Stuff Goes here</span> 
</div>

<div class="page3">
    <h2>Config/Settings</h2>
    <span>Sheet Config/Settings goes here</span> 
</div>

<div style="display: none;">
    <input type="hidden" name="attr_roll-ability__str" 
    value="&{template:sorrowstale-ability}{{check=[[1d20+@{strength_mod}]]}}{{charName=@{character_name}}}{{ability=Strength}}{{mod=@{strength_mod}}}"/>
    <input type="hidden" name="attr_roll-ability__con" 
    value="&{template:sorrowstale-ability}{{check=[[1d20+@{constitution_mod}]]}}{{charName=@{character_name}}}{{ability=Constitution}}{{mod=@{constitution_mod}}}"/>
    <input type="hidden" name="attr_roll-ability__agi" 
    value="&{template:sorrowstale-ability}{{check=[[1d20+@{agility_mod}]]}}{{charName=@{character_name}}}{{ability=Agility}}{{mod=@{agility_mod}}}"/>
    <input type="hidden" name="attr_roll-ability__awa" 
    value="&{template:sorrowstale-ability}{{check=[[1d20+@{aware_mod}]]}}{{charName=@{character_name}}}{{ability=Awareness}}{{mod=@{aware_mod}}}"/>
    <input type="hidden" name="attr_roll-ability__wil" 
    value="&{template:sorrowstale-ability}{{check=[[1d20+@{willpower_mod}]]}}{{charName=@{character_name}}}{{ability=Willpower}}{{mod=@{willpower_mod}}}"/>
    <input type="hidden" name="attr_roll-ability__int" 
    value="&{template:sorrowstale-ability}{{check=[[1d20+@{intelligence_mod}]]}}{{charName=@{character_name}}}{{ability=Intelligence}}{{mod=@{intelligence_mod}}}"/>
    <input type="hidden" name="attr_roll-ability__soc" 
    value="&{template:sorrowstale-ability}{{check=[[1d20+@{social_mod}]]}}{{charName=@{character_name}}}{{ability=Social Ability}}{{mod=@{social_mod}}}"/>
</div>


<script type="text/worker">
    function calculateMod(value) {
        if(value == 40) return 12; 
        else if (value == 39) return 11;
        else if (value >= 36 && value <= 38) return 10;
        else if (value >= 33 && value <= 35) return 9;
        else if (value >= 30 && value <= 32) return 8;
        else if (value >= 27 && value <= 29) return 7;
        else if (value >= 24 && value <= 26) return 6;
        else if (value >= 21 && value <= 23) return 5;
        else if (value >= 18 && value <= 20) return 4;
        else if (value >= 15 && value <= 17) return 3;
        else if (value >= 12 && value <= 14) return 2;
        else if (value >= 9 && value <= 11) return 1;
        else if (value == 8) return 0;
        else if (value == 7) return -1;
        else if (value == 6) return -2;
        else if (value == 5) return -4;
        else if (value == 4) return -6;
        else if (value == 3) return -8;
        else if (value == 2) return -10;
        else if (value == 1) return -12;
        else if (value == 0) return -99;
        else return -77;      
    }
  

    // handle 
    const buttonlist = ["page1","page2","page3"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });
    
    on("change:strength change:strength_curr change:constitution change:constitution_curr change:agility change:agility_curr " +
        "change:aware change:aware_curr change:willpower change:willpower_curr change:intelligence change:intelligence_curr " + 
        "change:social change:social_curr", function(eventInfo) {
        const attrib = eventInfo.sourceAttribute;
        getAttrs([attrib], function(values) {
            const attribVal = values[attrib];
            if (attribVal < 0){
                setAttrs({ [`${attrib}`]: 0}); 
            }
            else if (attribVal > 40){
                setAttrs({ [`${attrib}`]: 40});
            }
            else if (attrib.endsWith("_curr")) {
                setAttrs({ [`${attrib.slice(0, (attrib.length-5))}_mod`]: calculateMod(attribVal) });
            }
        });
    });

    on("change:agility_mod change:defense_talent_mod change:shield_rating", function() {
        getAttrs(["agility_mod", "defense_talent_mod", "shield_rating"], function(values) {
            let agm = parseInt(values.agility_mod)||0;
            let dtm = parseInt(values.defense_talent_mod)||0;
            let sr = parseInt(values.shield_rating)||0;
            let dr = (10+agm+dtm);
            let wsr = (dr+sr);
            setAttrs({defense_rating:dr, with_shield_rating:wsr});
        });
    });

    on("change:major_wound", function() {
        getAttrs(["major_wound"], function(values) {
            let mjw = parseInt(values.major_wound)||0;
            let newvalue = "";
            if (mjw==0){
                setAttrs({maj_wound_desc:newvalue});
            }
        });
    });       
    
</script>

    
    
 

 <rolltemplate class="sheet-rolltemplate-sorrowstale-ability">
    <div class="sheet-container">
        <div class="sheet-ability-roll">
            <p style="line-height: 1.8;">&nbsp;</p>
            {{#charName}}<span style="line-height: 2.3; font-size: 12px;">{{charName}} Rolls:</span>{{/charName}}<br />
            {{#check}}<span>{{check}}</span><br />{{/check}}
            {{#rollWasCrit() check}} <span>[ Critical Success ]</span>{{/rollWasCrit() check}}
            {{#rollWasFumble() check}}<span>[ Fail / Fumble ]</span>{{/rollWasFumble() check}}
         </div>
        <div class="sheet-ability-roll-footer">
            {{#ability}}<span class="sheet-ability-font">{{ability}} </span>{{/ability}}
            {{#mod}}<span class="sheet-ability-font"> ({{mod}}) </span>{{/mod}}
        </div>
    </div>       
 </rolltemplate>

 <rolltemplate class="sheet-rolltemplate-sorrowstale-sample">
    <div class="sheet-container sheet-color-{{color}}">
      <div class="sheet-header">
        {{#title}}<div class="sheet-title">{{title}} </div>{{/title}}
        {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
      </div>
      <div class="sheet-content">
        {{#allprops() title subtitle desc color}}
        <div class="sheet-key">{{key}}</div>
        <div class="sheet-value">{{value}}</div>
        {{/allprops() title subtitle desc color}}
        {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
      </div>
    </div>
  </rolltemplate> 
